<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sign Up - Pickify</title>
  <link rel="icon" href="./assests/favicon.ico">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="./css/header-footer.css">
  <link rel="stylesheet" href="./css/auth.css">
  <link rel="stylesheet" href="./css/signup.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">   
</head>
<body data-page-type="landingpage">
  <div id="header-placeholder"></div>

  <div class="auth-container">
    <div class="auth-card">
      <h1>Sign up</h1>
      <form id="signup-form">
        <label for="email">Email address</label>
        <input type="email" id="email" placeholder="Enter your email address" required>
        <div id="email-error" class="error-message">Please enter a valid email address</div>
        
        <label for="username">Username</label>
        <input type="text" id="username" placeholder="Enter your username" required>
        <div id="username-error" class="error-message">Username is required</div>
        
        <label for="password">Password</label>
        <div class="password-field">
          <input type="password" id="password" placeholder="Enter your password" required>
          <button type="button" class="password-toggle" onclick="togglePasswordVisibility(this)">
            <i class="fas fa-eye"></i>
          </button>
        </div>
        <div id="password-error" class="error-message">Password must be at least 8 characters with 1 uppercase letter and 1 symbol</div>
        
        <label for="confirm-password">Confirm Password</label>
        <div class="password-field">
          <input type="password" id="confirm-password" placeholder="Confirm your password" required>
          <button type="button" class="password-toggle" onclick="togglePasswordVisibility(this)">
            <i class="fas fa-eye"></i>
          </button>
        </div>
        <div id="confirm-password-error" class="error-message">Passwords do not match</div>
        
        <button type="submit" class="btn-primary">Sign up</button>
      </form>

      <p>If you already have an account, <a href="login.html">Login here!</a></p>
    </div>
  </div>

  <!-- Enhanced CAPTCHA Overlay and Modal -->
  <div id="captcha-overlay"></div>

  <div id="captcha-box">
    <h3>Security Verification</h3>
    <div id="canvas-container">
      <canvas id="canvas" width="120" height="40"></canvas>
      <button id="refresh-captcha" type="button">
        <i class="fas fa-sync-alt"></i>
      </button>
    </div>
    <input type="text" id="captcha-input" placeholder="Enter code" autocomplete="off" />
    <button class="btn-primary" id="captcha-submit">Verify</button>
    <div class="captcha-message">Can't read the code? Click the refresh icon.</div>
  </div>

  <!-- Success Message Modal -->
  <div id="success-modal" class="modal">
    <div class="modal-content">
      <div class="success-icon">
        <i class="fas fa-check-circle"></i>
      </div>
      <h3>Success!</h3>
      <p>Your account has been created successfully.</p>
      <button id="continue-btn" class="btn-primary">Continue to Login</button>
    </div>
  </div>

  <div id="footer-placeholder"></div>

<script src="./js/header-footer.js"></script>
<script>
  let generatedCaptcha = "";

  function togglePasswordVisibility(btn) {
    const input = btn.previousElementSibling;
    input.type = input.type === 'password' ? 'text' : 'password';
  }

  function getColor() {
    const r = Math.floor(Math.random() * 256);
    const g = Math.floor(Math.random() * 256);
    const b = Math.floor(Math.random() * 256);
    return `rgb(${r},${g},${b})`;
  }

  function generateCaptchaText() {
    const chars = '0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ';
    let code = '';
    for (let i = 0; i < 4; i++) {
      code += chars[Math.floor(Math.random() * chars.length)];
    }
    return code;
  }

  function drawCaptcha() {
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    ctx.clearRect(0, 0, 120, 40);
    ctx.fillStyle = '#f8fafc';
    ctx.fillRect(0, 0, 120, 40);

    ctx.strokeStyle = 'rgba(200, 200, 200, 0.2)';
    ctx.lineWidth = 0.5;
    for (let i = 0; i < 120; i += 10) {
      ctx.beginPath();
      ctx.moveTo(i, 0);
      ctx.lineTo(i, 40);
      ctx.stroke();
    }

    for (let i = 0; i < 40; i += 10) {
      ctx.beginPath();
      ctx.moveTo(0, i);
      ctx.lineTo(120, i);
      ctx.stroke();
    }

    generatedCaptcha = generateCaptchaText();
    for (let i = 0; i < generatedCaptcha.length; i++) {
      const x = 20 + i * 20;
      const y = 20 + 5 * Math.random();
      const deg = (Math.random() - 0.5) * Math.PI / 4;

      ctx.save();
      ctx.translate(x, y);
      ctx.rotate(deg);
      ctx.fillStyle = getColor();
      ctx.font = 'bold 22px sans-serif';
      ctx.fillText(generatedCaptcha[i], 0, 0);
      ctx.restore();
    }

    for (let i = 0; i < 5; i++) {
      ctx.beginPath();
      ctx.moveTo(Math.random() * 120, Math.random() * 40);
      ctx.bezierCurveTo(
        Math.random() * 120, Math.random() * 40,
        Math.random() * 120, Math.random() * 40,
        Math.random() * 120, Math.random() * 40
      );
      ctx.strokeStyle = getColor();
      ctx.lineWidth = 1;
      ctx.stroke();
    }

    for (let i = 0; i < 30; i++) {
      const x = Math.random() * 120;
      const y = Math.random() * 40;
      const size = Math.random() * 3;
      ctx.beginPath();
      ctx.arc(x, y, size, 0, Math.PI * 2);
      ctx.fillStyle = getColor();
      ctx.fill();
    }
  }

  document.getElementById('canvas').onclick = drawCaptcha;
  document.getElementById('refresh-captcha').onclick = drawCaptcha;

  // ✅ Modified submit handler — check duplicates before CAPTCHA
  document.getElementById('signup-form').addEventListener('submit', async function (e) {
    e.preventDefault();

    const email = document.getElementById('email').value.trim();
    const username = document.getElementById('username').value.trim();
    const password = document.getElementById('password').value;
    const confirmPassword = document.getElementById('confirm-password').value;

    let valid = true;
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    const passwordRegex = /^(?=.*[A-Z])(?=.*[!@#$%^&*()]).{8,}$/;

    document.querySelectorAll('.error-message').forEach(el => el.style.display = 'none');

    if (!emailRegex.test(email)) {
      document.getElementById('email-error').style.display = 'block';
      valid = false;
    }
    if (!username) {
      document.getElementById('username-error').style.display = 'block';
      valid = false;
    }
    if (!passwordRegex.test(password)) {
      document.getElementById('password-error').style.display = 'block';
      valid = false;
    }
    if (password !== confirmPassword) {
      document.getElementById('confirm-password-error').style.display = 'block';
      valid = false;
    }

    if (!valid) return;

    // ✅ Check for duplicates FIRST (case-sensitive)
    try {
      const res = await fetch('http://localhost:3000/User');
      const users = await res.json();

      const usernameExists = users.some(u => u.Name === username);
      const emailExists = users.some(u => u.Email === email);

      if (usernameExists) {
        document.getElementById('username-error').textContent = 'Username already exists';
        document.getElementById('username-error').style.display = 'block';
        return;
      }

      if (emailExists) {
        document.getElementById('email-error').textContent = 'Email address already in use';
        document.getElementById('email-error').style.display = 'block';
        return;
      }

      // ✅ Only show CAPTCHA if everything passes
      document.getElementById('captcha-box').style.display = 'block';
      document.getElementById('captcha-overlay').style.display = 'block';
      void document.getElementById('captcha-box').offsetWidth;
      document.getElementById('captcha-box').classList.add('active');
      document.getElementById('captcha-input').value = '';
      drawCaptcha();

    } catch (err) {
      alert('Failed to validate user uniqueness:\n' + err.message);
    }
  });

  document.getElementById('captcha-submit').addEventListener('click', async function () {
    const input = document.getElementById('captcha-input').value.trim();
    if (input !== generatedCaptcha) {
      const captchaBox = document.getElementById('captcha-box');
      captchaBox.classList.add('shake');
      setTimeout(() => captchaBox.classList.remove('shake'), 500);
      document.getElementById('captcha-input').value = '';
      drawCaptcha();
      return;
    }

    const email = document.getElementById('email').value.trim();
    const username = document.getElementById('username').value.trim();
    const password = document.getElementById('password').value;

    try {
      const post = await fetch('http://localhost:3000/User', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ Name: username, Email: email, Password: password })
      });

      if (!post.ok) throw new Error(await post.text());

      document.getElementById('captcha-box').classList.remove('active');
      setTimeout(() => {
        document.getElementById('captcha-box').style.display = 'none';
        const successModal = document.getElementById('success-modal');
        const modalContent = successModal.querySelector('.modal-content');
        successModal.style.display = 'block';
        void modalContent.offsetWidth;
        modalContent.classList.add('active');
      }, 300);
    } catch (err) {
      document.getElementById('captcha-box').classList.remove('active');
      setTimeout(() => {
        document.getElementById('captcha-box').style.display = 'none';
        document.getElementById('captcha-overlay').style.display = 'none';
        alert('Signup failed:\n' + err.message);
      }, 300);
    }
  });

  // Shake animation style
  document.head.insertAdjacentHTML('beforeend', `
    <style>
      @keyframes shake {
        0%, 100% { transform: translate(-50%, -50%); }
        10%, 30%, 50%, 70%, 90% { transform: translate(-52%, -50%); }
        20%, 40%, 60%, 80% { transform: translate(-48%, -50%); }
      }
      #captcha-box.shake {
        animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
      }
    </style>
  `);

  document.getElementById('continue-btn').addEventListener('click', function() {
    window.location.href = 'login.html';
  });
</script>

</body>
</html>